# Federation: 1999 - Copilot Instructions

## Overview

Recreation of Federation space fantasy game (1999). Multi-process networked game server using Go 1.25.2, C, and C++. Target: Linux/amd64.

**Components**: modemd (C modem simulator) → telnetd (system) → login (Go auth) → perivale (C I/O driver) → fedtpd (Go game engine). Also: workbench (C++ planet editor), httpd (Go web server).

**Libraries**: internal/ibgames (C account DB), internal/fed (C++ workbench validation).

## Build Instructions

**Prerequisites**: Go 1.25.2, GCC/G++, make, awk/sed/perl. Optional: Node.js/npm (website), Hugo 0.150.1 extended (website), golangci-lint (linting). Non-Linux: Docker auto-used.

**CRITICAL BUILD ORDER**:
1. `make generate` (MUST BE FIRST - generates parser.tab.go and messages.go from yacc/data files, ~4s)
2. `make build` (builds C libs → C++ libs → all binaries, ~5s incremental / ~55s clean, outputs to bin/linux-amd64/)
3. `make website` (optional, needs Hugo, outputs to web/public/)

**Quick commands**:
- Clean build: `make clean && make generate && make build`
- Complete build: `make all` (does generate + build + website)
- Test: `make test` (variable time, auth tests ~2s)
- Lint: `make lint` (needs golangci-lint installed separately)

## Linting & Testing

**Lint**: `make lint` - Config: .golangci.yaml (v2 format). Uses gofumpt, goimports formatters. Excludes warnings for generated files like internal/text/messages.go.

**Test**: `make test` - macOS: generates coverage report. Linux: runs `go test ./...`. Auth tests take 2+ seconds.

## Project Layout

**Root**: Makefile (main orchestration), go.mod, Dockerfile.build, fly.yaml (Fly.io deploy), .golangci.yaml, .clang-format, .editorconfig

**cmd/**: Binaries - fedtpd/ httpd/ login/ (Go), modemd/ perivale/ workbench/ (C/C++ with Makefiles)

**internal/**: Go packages + C/C++ libs
- fed/ - C++ workbench lib (Makefile in lib/)
- ibgames/ - C account DB lib (Makefile in lib/)  
- server/ - Go game engine (parser/ has yacc, sol/ has systems, database/ has DB access)
- text/ - Text processing (messages.go is GENERATED from data/messages.txt)
- version/ - Contains VERSION file (10.0.23)

**pkg/ibgames/auth/**: Public auth package (2+ second tests)

**data/**: messages.txt (source for code generation), person.d/, workbench*/ (player data)

**db/migrations/**: SQL files for ibgames.sqlite

**web/**: Hugo site - package.json (needs npm ci), hugo.yaml, content/, layouts/, outputs to public/

**scripts/**: docker-build.sh, init-ibgames-db.sh (needs DBPATH env var), publish-to-github.sh

**tools/**: gen-text.{sh,awk,pl} - Code generators for messages.go

## CI/CD Pipeline

**.github/workflows/ci.yml**: ubuntu-latest, triggers on push/PR to main. Steps: checkout → setup Go → install Hugo 0.150.1 → make generate → golangci-lint → make (=generate+build+website). **Does NOT run tests**.

**.github/workflows/codeql.yml**: Security scanning for Go/JS/C++.

## Generated Files (DO NOT EDIT)

- internal/server/parser/parser.tab.go + y.output (from parser.tab.y via goyacc)
- internal/text/messages.go (from data/messages.txt, 548KB!)
- internal/workbench/messages.go

Run `make generate` after modifying: parser.tab.y, data/messages.txt, or tools/gen-text.* scripts.

## Known Issues & Validation

**Platform behavior**: Linux builds natively. macOS/other auto-uses Docker (Dockerfile.build has libncurses-dev).

**Expected C/C++ warnings**: Type conversions (-Wconversion), unused write() returns in workbench code - these are normal.

**TODO/FIXME comments**: 30+ instances like "Not implemented. Check back in 2 weeks" - normal for recreation, don't fix unless requested.

**Database init**: scripts/init-ibgames-db.sh requires DBPATH env var, creates/updates ibgames.sqlite from db/migrations/, backs up first.

**Validation after changes**:
1. Clean: `make clean && make generate && make build`
2. Incremental: `make build` (<10s for Go-only changes)
3. Test: `make test`
4. Lint: `make lint` (if installed)

**Dependencies**: Go: prometheus, gorilla/websocket, mattn/go-sqlite3, goyacc tool. C/C++: libncurses-dev, POSIX C, C++11.

**File patterns**: Go binaries in cmd/*/main.go. C/C++ with local Makefiles in cmd/*/. Generated code has `//go:build !ignore_autogenerated` or `DO NOT EDIT`.

**Style**: Go uses gofumpt/goimports, C uses .clang-format, all respect .editorconfig.

**Trust these instructions** - validated by actual execution. If errors: verify command order, check `make generate` ran first, confirm Linux or Docker available.
